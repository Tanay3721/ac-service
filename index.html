<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AC Service – Cloud</title>

  <!-- Firebase compat (no import error) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    /* your original CSS (unchanged) */
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background:linear-gradient(135deg,#f0f7ff 0%,#e6f0ff 100%);color:#2d3748;line-height:1.6}
    header{background:linear-gradient(90deg,#1a365d 0%,#2c5282 100%);color:#fff;padding:25px 0;text-align:center}
    .section{display:none;background:#fff;margin:20px auto;max-width:900px;padding:25px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
    .btn{padding:12px 24px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all .3s ease}
    .btn-primary{background:linear-gradient(90deg,#2b6cb0 0%,#3182ce 100%);color:#fff}
    .btn-secondary{background:linear-gradient(90deg,#38a169 0%,#48bb78 100%);color:#fff}
    .btn-danger{background:linear-gradient(90deg,#e53e3e 0%,#fc8181 100%);color:#fff}
    .btn-success{background:linear-gradient(90deg,#38a169 0%,#68d391 100%);color:#fff}
    .login-section,.register-section{background:#fff;margin:30px auto;max-width:420px;padding:30px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
    .form-group{margin-bottom:20px}label{font-weight:600}input,select,textarea{width:100%;padding:10px;border:1px solid #cbd5e0;border-radius:8px}
    .card{padding:18px;margin:10px 0;border-radius:8px;border:1px solid #e2e8f0}
    .status-pending{background:#ed8936;color:#fff}.status-assigned{background:#3182ce;color:#fff}.status-completed{background:#38a169;color:#fff}
    .login-links{text-align:center;margin-top:15px}
  </style>
</head>

<body>
  <header><h1>AC Service Management – Cloud</h1></header>

  <!-- LOGIN -->
  <div id="loginSection" class="login-section">
    <h2>Login</h2>
    <form id="loginForm">
      <div class="form-group"><label>Email</label><input type="email" id="email" required></div>
      <div class="form-group"><label>Password</label><input type="password" id="password" required></div>
      <button class="btn btn-primary" type="submit">Login</button>
    </form>
    <div class="login-links">
      <button class="btn btn-secondary" onclick="showRegister()">Create new account</button>
    </div>
    <!-- <p style="margin-top:15px;font-size:14px;color:#555">
      Demo:<br>Admin → admin@acservice.com / admin123<br>Employee → tech@acservice.com / tech1234
    </p> -->
  </div>

  <!-- REGISTER -->
  <div id="registerSection" class="register-section" style="display:none">
    <h2>Register</h2>
    <form id="registerForm">
      <div class="form-group"><label>Full Name</label><input id="regName" required></div>
      <div class="form-group"><label>Email</label><input type="email" id="regEmail" required></div>
      <div class="form-group"><label>Password</label><input type="password" id="regPass" required></div>
      <div class="form-group"><label>Role</label>
        <select id="regRole"><option value="customer">Customer</option><option value="employee">Employee</option></select>
      </div>
      <button class="btn btn-primary" type="submit">Register</button>
      <button class="btn btn-secondary" type="button" onclick="showLogin()">Back</button>
    </form>
  </div>

  <!-- CUSTOMER DASH -->
  <div id="customerSection" class="section">
    <h2>Customer Dashboard <button class="btn btn-danger" style="float:right" onclick="logout()">Logout</button></h2>
    <h3>File a Complaint</h3>
    <form id="complaintForm">
      <div class="form-group"><label>Description</label><textarea id="desc" required></textarea></div>
      <button class="btn btn-primary" type="submit">Submit</button>
    </form>
    <h3 style="margin-top:30px">My Complaints</h3><div id="custList"></div>
  </div>

  <!-- ADMIN DASH -->
  <div id="adminSection" class="section">
    <h2>Admin Dashboard <button class="btn btn-danger" style="float:right" onclick="logout()">Logout</button></h2>
    <h3>Pending Complaints</h3><div id="pendList"></div>
    <h3 style="margin-top:30px">Assigned Tasks</h3><div id="assList"></div>
    <h3 style="margin-top:30px">Completed Tasks</h3><div id="compList"></div>
  </div>

  <!-- EMPLOYEE DASH -->
  <div id="employeeSection" class="section">
    <h2>Employee Dashboard <button class="btn btn-danger" style="float:right" onclick="logout()">Logout</button></h2>
    <h3>My Tasks</h3><div id="empList"></div>
  </div>

  <script>
    /* ========= 1.  FIREBASE CONFIG ========= */
    const firebaseConfig = {
    apiKey: "AIzaSyB5Ubw6wWRN7Buo964rimEOpw-2fJRWvmg",
    authDomain: "ac-service-80e2d.firebaseapp.com",
    databaseURL: "https://ac-service-80e2d-default-rtdb.firebaseio.com",
    projectId: "ac-service-80e2d",
    storageBucket: "ac-service-80e2d.firebasestorage.app",
    messagingSenderId: "353757529591",
    appId: "1:353757529591:web:6156439e692e1b3e469af2",
    measurementId: "G-EMFXR8JQXW"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const root = db.ref();

    /* ========= 2.  SEED DEMO ACCOUNTS (once) ========= */
    (async () => {
      const u = await root.child('users').once('value');
      if (!u.exists()) {
        await root.child('users/admin@acservice').set({name:'Admin',role:'admin',password:'admin123'});
        await root.child('users/tech@acservice').set({name:'Technician',role:'employee',password:'tech1234'});
      }
    })();

    /* ========= 3.  ROUTING ========= */
    function showLogin(){ document.getElementById('loginSection').style.display='block'; document.getElementById('registerSection').style.display='none'; }
    function showRegister(){ document.getElementById('loginSection').style.display='none'; document.getElementById('registerSection').style.display='block'; }
    function logout(){ sessionStorage.clear(); location.reload(); }

    /* ========= 4.  LOGIN ========= */
    document.getElementById('loginForm').addEventListener('submit', async e => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const pass  = document.getElementById('password').value.trim();
      const snap  = await root.child(`users/${email.replace(/\./g,',')}`).once('value');
      if (snap.exists() && snap.val().password === pass) {
        const user = {email, ...snap.val()};
        sessionStorage.setItem('user', JSON.stringify(user));
        route(user.role);
      } else { alert('Invalid credentials'); }
    });

    /* ========= 5.  REGISTER ========= */
    document.getElementById('registerForm').addEventListener('submit', async e => {
      e.preventDefault();
      const email = document.getElementById('regEmail').value.trim();
      const exist = await root.child(`users/${email.replace(/\./g,',')}`).once('value');
      if (exist.exists()) return alert('Email already registered');
      const newUser = {
        name: document.getElementById('regName').value.trim(),
        role: document.getElementById('regRole').value,
        password: document.getElementById('regPass').value
      };
      await root.child(`users/${email.replace(/\./g,',')}`).set(newUser);
      alert('Registration successful – please log in');
      showLogin();
    });

    function route(role){
      document.getElementById('loginSection').style.display='none';
      document.getElementById('registerSection').style.display='none';
      if (role==='admin'){document.getElementById('adminSection').style.display='block';adminListeners();}
      else if (role==='employee'){document.getElementById('employeeSection').style.display='block';empListeners();}
      else {document.getElementById('customerSection').style.display='block';custListeners();}
    }

    /* ========= 6.  CUSTOMER ========= */
    function custListeners(){
      const user=JSON.parse(sessionStorage.getItem('user'));
      const ref=root.child('complaints').orderByChild('customerEmail').equalTo(user.email);
      ref.on('value',snap=>{
        const list=document.getElementById('custList');
        list.innerHTML='';
        snap.forEach(ch=>{const c=ch.val(); list.innerHTML+=card(`Complaint ${c.id}`,c.desc,c.status);});
        if(!snap.exists())list.innerHTML='<p>No complaints yet.</p>';
      });
      document.getElementById('complaintForm').addEventListener('submit',async e=>{
        e.preventDefault();
        const id='COMP'+Date.now();
        await root.child(`complaints/${id}`).set({
          id, customerEmail:user.email, customerName:user.name,
          desc:document.getElementById('desc').value, status:'pending',
          date:new Date().toLocaleDateString()
        });
        e.target.reset();
      });
    }

    /* ========= 7.  ADMIN ========= */
    function adminListeners(){
      root.child('complaints').on('value',snap=>{
        const pend=[]; snap.forEach(ch=>{const c=ch.val(); if(c.status==='pending')pend.push(c);});
        const html=pend.length? pend.map(c=>card(c.id,c.desc,c.status,`
          <select id="sel${c.id}"><option value="">Pick employee</option>
          <option>John Smith</option><option>Mike Johnson</option><option>Sarah Williams</option></select>
          <button class="btn btn-primary btn-sm" onclick="assign('${c.id}')">Assign</button>`))
        :'<p>Nothing pending.</p>';
        document.getElementById('pendList').innerHTML=html;
      });
      root.child('tasks').on('value',snap=>{
        const ass=[],comp=[]; snap.forEach(ch=>{const t=ch.val(); (t.status==='assigned'?ass:comp).push(t);});
        document.getElementById('assList').innerHTML=ass.length?ass.map(t=>card(t.id,`${t.desc}<br><small>to <b>${t.emp}</b></small>`,t.status)) :'<p>None assigned.</p>';
        document.getElementById('compList').innerHTML=comp.length?comp.map(t=>card(t.id,`${t.desc}<br><small>by <b>${t.emp}</b></small>`,t.status)) :'<p>None completed.</p>';
      });
    }
    window.assign=async id=>{
      const emp=document.getElementById('sel'+id).value;
      if(!emp)return alert('Choose employee');
      const c=(await root.child(`complaints/${id}`).once('value')).val();
      await root.child(`complaints/${id}`).update({status:'assigned'});
      await root.child(`tasks/${id}`).set({id,emp,desc:c.desc,status:'assigned',assignedDate:new Date().toLocaleDateString()});
    };

    /* ========= 8.  EMPLOYEE ========= */
    function empListeners(){
      const user=JSON.parse(sessionStorage.getItem('user'));
      const ref=root.child('tasks').orderByChild('emp').equalTo(user.name);
      ref.on('value',snap=>{
        const list=document.getElementById('empList');
        list.innerHTML='';
        snap.forEach(ch=>{
          const t=ch.val(); if(t.status==='assigned')list.innerHTML+=card(t.id,t.desc,t.status,`<button class="btn btn-success btn-sm" onclick="complete('${t.id}')">Mark complete</button>`);
        });
        if(!list.innerHTML)list.innerHTML='<p>No open tasks.</p>';
      });
    }
    window.complete=async id=>{
      await root.child(`tasks/${id}`).update({status:'completed',completedDate:new Date().toLocaleDateString()});
      await root.child(`complaints/${id}`).update({status:'completed'});
    };

    /* ========= 9.  CARD HELPER ========= */
    function card(title,body,status,extra=''){
      return`<div class="card"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><b>${title}</b><span class="status status-${status}">${status.toUpperCase()}</span></div><p>${body}</p>${extra?`<div style="margin-top:10px">${extra}</div>`:''}</div>`;
    }

    /* ========= 10.  ON LOAD ========= */
    (async()=>{
      const u=sessionStorage.getItem('user');
      if(u)route(JSON.parse(u).role);
    })();
  </script>
</body>
</html>